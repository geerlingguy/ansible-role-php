---
- hosts: all

  vars:
    php_enable_webserver: true
    php_version: 5.6
    php_enablerepo: "remi,remi-php56"
    php_memory_limit: "191M"
    php_webserver_daemon: "nginx"

    php_enable_php_fpm: true
    php_fpm_listen: "127.0.0.1:9000"

    nginx_vhosts:
      - listen: "80 default_server"
        server_name: "test.dev"
        root: "/var/www/test"
        index: "index.php"
        extra_parameters: |
              location ~ \.php$ {
                fastcgi_split_path_info ^(.+?\.php)(|/.*)$;
                fastcgi_index index.php;
                fastcgi_param SCRIPT_FILENAME $request_filename;
                fastcgi_intercept_errors on;
                fastcgi_read_timeout 120;
                include fastcgi_params;
                fastcgi_pass 127.0.0.1:9000
              }

  pre_tasks:
    - name: Ensure build dependencies are installed (RedHat).
      yum: name=which state=present
      when: ansible_os_family == 'RedHat'

    - name: Add repository for PHP 5.6.
      apt_repository: repo='ppa:ondrej/php5-5.6'
      when: ansible_os_family == 'Debian'

  roles:
    - { role: geerlingguy.repo-remi, when: ansible_os_family == 'RedHat' }
    - geerlingguy.nginx
    - role_under_test
